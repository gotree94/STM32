# USB Device Class 및 PC 드라이버 요구사항 가이드

STM32 USB Device 개발 시 각 USB Class별 PC 드라이버 및 소프트웨어 요구사항을 정리합니다.

## 📋 개요

USB Device를 개발할 때 가장 중요한 결정 중 하나는 **USB Class 선택**입니다. 선택한 Class에 따라 PC 측 드라이버/소프트웨어 요구사항이 크게 달라집니다.

## 🎯 USB Class별 드라이버 요구사항 요약

| USB Class | 용도 | PC 드라이버 | PC 소프트웨어 | 개발 난이도 |
|-----------|------|------------|--------------|------------|
| **MSC** | USB 메모리 | ❌ 불필요 | ❌ 불필요 | ⭐ |
| **HID** | 키보드/마우스 | ❌ 불필요 | ❌ 불필요 | ⭐ |
| **CDC** | 가상 COM 포트 | △ 일부 필요 | 터미널 프로그램 | ⭐⭐ |
| **Audio** | USB 오디오 | ❌ 불필요 | ❌ 불필요 | ⭐⭐⭐ |
| **Video (UVC)** | USB 카메라 | ❌ 불필요 | ❌ 불필요 | ⭐⭐⭐⭐ |
| **USBTMC** | 계측기 | ✅ 필요 | LabVIEW 등 | ⭐⭐⭐ |
| **Custom** | 독자 프로토콜 | ✅ **필요** | ✅ **필요** | ⭐⭐⭐⭐⭐ |

## 📁 1. MSC (Mass Storage Class) - 드라이버 불필요

### 동작 방식

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MSC = USB 저장장치 표준                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   STM32 USB Device                         PC (Windows/Mac/Linux)          │
│   ┌─────────────────────┐                 ┌─────────────────────┐          │
│   │                     │                 │                     │          │
│   │  USB MSC Class      │ ── USB 연결 ──▶ │  OS 내장 드라이버   │          │
│   │  (SCSI 프로토콜)    │                 │  (자동 로드)        │          │
│   │                     │                 │                     │          │
│   │  ┌───────────────┐  │                 │  ┌───────────────┐  │          │
│   │  │ Storage Media │  │ ◀── 파일 ────▶ │  │ 📁 탐색기     │  │          │
│   │  │ (SD/Flash)    │  │    읽기/쓰기    │  │ (E: 드라이브) │  │          │
│   │  └───────────────┘  │                 │  └───────────────┘  │          │
│   └─────────────────────┘                 └─────────────────────┘          │
│                                                                             │
│   ✅ 드라이버: 불필요 (OS 내장)                                             │
│   ✅ 소프트웨어: 불필요 (탐색기로 접근)                                     │
│   ✅ 지원 OS: Windows, macOS, Linux, Android 모두                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 사용 사례

- 데이터 로깅 후 파일 다운로드
- 설정 파일 업로드/다운로드
- 펌웨어 업데이트 파일 전달
- 일반 파일 교환

### 장단점

| 장점 | 단점 |
|------|------|
| 드라이버/소프트웨어 불필요 | 실시간 통신 불가 |
| 모든 OS 자동 지원 | 파일 단위 전송만 가능 |
| 사용자 친화적 | 양방향 즉시 통신 어려움 |

---

## 🔌 2. CDC (Communications Device Class) - 드라이버 일부 필요

### 동작 방식

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CDC = 가상 COM 포트                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   STM32 USB Device                         PC                               │
│   ┌─────────────────────┐                 ┌─────────────────────┐          │
│   │                     │                 │                     │          │
│   │  USB CDC Class      │ ── USB 연결 ──▶ │  CDC 드라이버       │          │
│   │                     │                 │  (OS별 상이)        │          │
│   │                     │                 │                     │          │
│   │  HAL_UART_Transmit  │ ◀── 데이터 ──▶ │  COM3 포트          │          │
│   │  CDC_Receive_FS     │    스트림       │  (터미널 프로그램)  │          │
│   │                     │                 │                     │          │
│   └─────────────────────┘                 └─────────────────────┘          │
│                                                                             │
│   드라이버 요구사항:                                                        │
│   • Windows 10+: ✅ 자동 인식 (대부분)                                      │
│   • Windows 7/8: ⚠️ INF 파일 또는 ST 드라이버 필요                         │
│   • macOS: ✅ 자동 인식                                                     │
│   • Linux: ✅ 자동 인식                                                     │
│                                                                             │
│   소프트웨어: 터미널 프로그램 필요 (PuTTY, Tera Term 등)                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Windows INF 파일 (필요 시)

```ini
; stm32_cdc.inf
[Version]
Signature="$Windows NT$"
Class=Ports
ClassGuid={4D36E978-E325-11CE-BFC1-08002BE10318}
Provider=%ManufacturerName%
DriverVer=01/01/2024,1.0.0.0

[Manufacturer]
%ManufacturerName%=DeviceList, NTamd64

[DeviceList.NTamd64]
%DeviceName%=DriverInstall, USB\VID_0483&PID_5740

[DriverInstall]
include=mdmcpq.inf
CopyFiles=FakeModemCopyFileSection
AddReg=DriverAddReg

[DriverAddReg]
HKR,,DevLoader,,*ntkern
HKR,,NTMPDriver,,usbser.sys
HKR,,EnumPropPages32,,"MsPorts.dll,SerialPortPropPageProvider"

[Strings]
ManufacturerName="STMicroelectronics"
DeviceName="STM32 Virtual COM Port"
```

### 사용 사례

- 디버그 출력 (printf)
- 명령어 인터페이스 (CLI)
- 실시간 데이터 스트리밍
- PC 소프트웨어와 통신

---

## ⌨️ 3. HID (Human Interface Device) - 드라이버 불필요

### 동작 방식

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         HID = 입력장치 표준                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   STM32 USB Device                         PC                               │
│   ┌─────────────────────┐                 ┌─────────────────────┐          │
│   │                     │                 │                     │          │
│   │  USB HID Class      │ ── USB 연결 ──▶ │  OS 내장 HID 드라이버│         │
│   │                     │                 │  (자동)              │          │
│   │  • Keyboard         │                 │                     │          │
│   │  • Mouse            │ ◀── 입력 ────▶ │  응용 프로그램       │          │
│   │  • Custom HID       │    리포트       │  (모든 프로그램)     │          │
│   │                     │                 │                     │          │
│   └─────────────────────┘                 └─────────────────────┘          │
│                                                                             │
│   ✅ 드라이버: 불필요 (OS 내장)                                             │
│   ✅ 소프트웨어: 불필요 (키보드/마우스) 또는 필요 (Custom HID)             │
│                                                                             │
│   Custom HID 사용 시:                                                       │
│   • 64 bytes/packet 제한                                                    │
│   • 양방향 통신 가능                                                        │
│   • PC 소프트웨어에서 HID API 사용                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Custom HID 예시 (PC 측 Python)

```python
import hid

# STM32 HID 장치 열기
device = hid.device()
device.open(0x0483, 0x5750)  # VID, PID

# 데이터 송신
device.write([0x00, 0x01, 0x02, 0x03])

# 데이터 수신
data = device.read(64)
print(f"Received: {data}")

device.close()
```

---

## 🎵 4. Audio Class - 드라이버 불필요

### 동작 방식

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Audio = USB 오디오 표준                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   STM32 USB Device                         PC                               │
│   ┌─────────────────────┐                 ┌─────────────────────┐          │
│   │                     │                 │                     │          │
│   │  USB Audio Class    │ ── USB 연결 ──▶ │  OS 내장 오디오     │          │
│   │                     │                 │  드라이버 (자동)    │          │
│   │  ┌───────────────┐  │                 │                     │          │
│   │  │ I2S / SAI     │  │ ◀── 오디오 ──▶ │  🔊 스피커로 인식   │          │
│   │  │ Audio Codec   │  │    스트림       │  🎤 마이크로 인식   │          │
│   │  └───────────────┘  │                 │                     │          │
│   └─────────────────────┘                 └─────────────────────┘          │
│                                                                             │
│   ✅ 드라이버: 불필요 (UAC 1.0/2.0 표준)                                   │
│   ✅ 소프트웨어: 불필요 (OS 오디오 장치로 인식)                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📹 5. Video Class (UVC) - 드라이버 불필요

### 동작 방식

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         UVC = USB 카메라 표준                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   STM32 USB Device                         PC                               │
│   ┌─────────────────────┐                 ┌─────────────────────┐          │
│   │                     │                 │                     │          │
│   │  USB Video Class    │ ── USB 연결 ──▶ │  OS 내장 UVC        │          │
│   │  (UVC 1.0/1.1)      │                 │  드라이버 (자동)    │          │
│   │                     │                 │                     │          │
│   │  ┌───────────────┐  │                 │  ┌───────────────┐  │          │
│   │  │ Camera Sensor │  │ ── 영상 ──────▶ │  │ 📷 카메라 앱  │  │          │
│   │  │ (OV7670 등)   │  │    스트림       │  │ Zoom, Skype   │  │          │
│   │  └───────────────┘  │                 │  └───────────────┘  │          │
│   └─────────────────────┘                 └─────────────────────┘          │
│                                                                             │
│   ✅ 드라이버: 불필요 (UVC 표준)                                            │
│   ✅ 소프트웨어: 불필요 (카메라 앱에서 자동 인식)                           │
│                                                                             │
│   지원 포맷: MJPEG, YUV (비압축)                                           │
│   해상도: USB 대역폭에 따라 제한                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔬 6. USBTMC (Test & Measurement Class) - 드라이버 필요

### LabVIEW/계측기용

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         USBTMC = 계측기 표준                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   STM32 USB Device                         PC                               │
│   ┌─────────────────────┐                 ┌─────────────────────┐          │
│   │                     │                 │                     │          │
│   │  USB TMC Class      │ ── USB 연결 ──▶ │  NI-VISA 드라이버   │          │
│   │  (IEEE 488.2)       │                 │  (설치 필요)        │          │
│   │                     │                 │                     │          │
│   │  SCPI 명령어        │ ◀── 명령 ────▶ │  LabVIEW            │          │
│   │  "*IDN?"            │    응답         │  MATLAB             │          │
│   │  "MEAS:VOLT?"       │                 │  Python (pyvisa)    │          │
│   │                     │                 │                     │          │
│   └─────────────────────┘                 └─────────────────────┘          │
│                                                                             │
│   ✅ 드라이버: NI-VISA 또는 Keysight IO Libraries 필요                     │
│   ✅ 소프트웨어: LabVIEW, MATLAB, Python 등                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🛠️ 7. Custom/Vendor Class - 모두 필요

### 독자 프로토콜

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Custom = 독자 프로토콜                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   STM32 USB Device                         PC                               │
│   ┌─────────────────────┐                 ┌─────────────────────┐          │
│   │                     │                 │                     │          │
│   │  Vendor Specific    │ ── USB 연결 ──▶ │  ❌ 인식 안됨       │          │
│   │  Class (0xFF)       │                 │                     │          │
│   │                     │                 │  ⬇️ 드라이버 설치   │          │
│   │                     │                 │                     │          │
│   │  독자 프로토콜      │ ◀── 통신 ────▶ │  ✅ WinUSB 또는     │          │
│   │                     │                 │     libusb 사용     │          │
│   │                     │                 │                     │          │
│   └─────────────────────┘                 └─────────────────────┘          │
│                                                                             │
│   ✅ 드라이버: WinUSB (권장) 또는 Custom 드라이버                          │
│   ✅ 소프트웨어: 직접 개발 필요                                             │
│                                                                             │
│   WinUSB 장점:                                                              │
│   • Microsoft 서명됨 (별도 서명 불필요)                                    │
│   • INF 파일만 제공하면 됨                                                  │
│   • libusb-win32로 접근 가능                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### WinUSB INF 파일 예시

```ini
; stm32_winusb.inf
[Version]
Signature = "$Windows NT$"
Class = USBDevice
ClassGUID = {88BAE032-5A81-49f0-BC3D-A4FF138216D6}
Provider = %ManufacturerName%
DriverVer = 01/01/2024,1.0.0.0

[Manufacturer]
%ManufacturerName% = Standard, NTamd64

[Standard.NTamd64]
%DeviceName% = USB_Install, USB\VID_0483&PID_5741

[USB_Install]
Include = winusb.inf
Needs = WINUSB.NT

[USB_Install.Services]
Include = winusb.inf
Needs = WINUSB.NT.Services

[USB_Install.HW]
AddReg = AddDeviceInterfaceGUID

[AddDeviceInterfaceGUID]
HKR,,DeviceInterfaceGUIDs,0x00010000,"{12345678-1234-1234-1234-123456789ABC}"

[Strings]
ManufacturerName = "My Company"
DeviceName = "STM32 Custom Device"
```

---

## 📊 선택 가이드

### 용도별 권장 USB Class

| 용도 | 권장 Class | 드라이버 | 개발 난이도 |
|------|-----------|----------|------------|
| 파일 전송 | **MSC** | ❌ | ⭐ |
| 디버그 출력 | **CDC** | △ | ⭐⭐ |
| 실시간 센서 데이터 | CDC 또는 Custom | △~✅ | ⭐⭐~⭐⭐⭐ |
| 키보드/매크로 | **HID** | ❌ | ⭐⭐ |
| 계측기 (LabVIEW) | **USBTMC** | ✅ | ⭐⭐⭐ |
| 카메라/스캐너 | **UVC** | ❌ | ⭐⭐⭐⭐ |
| 오디오 장치 | **Audio** | ❌ | ⭐⭐⭐ |
| 고속 데이터 수집 | Custom (WinUSB) | ✅ | ⭐⭐⭐⭐ |

### 플로우차트

```
                    ┌─────────────────────┐
                    │   USB 장치 개발     │
                    └──────────┬──────────┘
                               │
                    ┌──────────▼──────────┐
                    │  주요 기능은?        │
                    └──────────┬──────────┘
                               │
        ┌──────────┬───────────┼───────────┬──────────┐
        │          │           │           │          │
        ▼          ▼           ▼           ▼          ▼
   ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
   │파일전송│ │시리얼  │ │입력장치│ │영상/   │ │계측기/ │
   │        │ │통신    │ │        │ │오디오  │ │DAQ     │
   └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘
       │          │          │          │          │
       ▼          ▼          ▼          ▼          ▼
   ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
   │  MSC   │ │  CDC   │ │  HID   │ │UVC/UAC │ │USBTMC/ │
   │        │ │        │ │        │ │        │ │Custom  │
   │드라이버│ │드라이버│ │드라이버│ │드라이버│ │드라이버│
   │ 불필요 │ │일부필요│ │ 불필요 │ │ 불필요 │ │ 필요   │
   └────────┘ └────────┘ └────────┘ └────────┘ └────────┘
```

## 📚 참고 자료

- [USB.org - Device Class Specifications](https://www.usb.org/documents)
- [Microsoft - WinUSB](https://docs.microsoft.com/en-us/windows-hardware/drivers/usbcon/winusb)
- [libusb Documentation](https://libusb.info/)
- [STM32 USB Device Library](https://www.st.com/resource/en/user_manual/um1734-stm32cube-usb-device-library-stmicroelectronics.pdf)

## 📝 라이선스

This document is licensed under the MIT License.

## ✍️ Author

Created for STM32 embedded systems development reference.
