# STM32F103 Smart Guard Rover - 시스템 분석 문서

## 📋 개요

본 문서는 STM32F103 기반 Smart Guard Rover 시스템의 하드웨어/소프트웨어 구조를 분석하고, 타이밍 특성을 검토하여 최적화 방안을 제시합니다.

---

## 1. 하드웨어 구조 분석

### 1.1 MCU 사양

| 항목 | 사양 |
|------|------|
| MCU | STM32F103 (Cortex-M3) |
| 클럭 소스 | HSI (8MHz 내부 RC) |
| PLL 설정 | HSI/2 × 16 = 64MHz |
| SYSCLK | 64MHz |
| AHB (HCLK) | 64MHz (DIV1) |
| APB1 (PCLK1) | 32MHz (DIV2) |
| APB2 (PCLK2) | 64MHz (DIV1) |
| Flash Latency | 2 Wait States |

### 1.2 GPIO 포트 할당

```
┌─────────────────────────────────────────────────────────────┐
│                    STM32F103 GPIO Map                       │
├─────────────┬───────────────────────────────────────────────┤
│   GPIOA     │                                               │
├─────────────┼───────────────────────────────────────────────┤
│ PA0         │ DHT11 (온습도 센서) - 양방향                  │
│ PA1         │ LCD_RES (리셋)                                │
│ PA4         │ TEMPER (온도 입력)                            │
│ PA5         │ SPI1_SCK                                      │
│ PA6         │ LCD_DC (Data/Command)                         │
│ PA7         │ SPI1_MOSI                                     │
│ PA8         │ TRIG2 (초음파 2번 트리거)                     │
│ PA9         │ LBF (Left Back Forward)                       │
│ PA10        │ LFB (Left Front Back)                         │
│ PA11        │ ECHO2 (초음파 2번 에코)                       │
├─────────────┼───────────────────────────────────────────────┤
│   GPIOB     │                                               │
├─────────────┼───────────────────────────────────────────────┤
│ PB0         │ ECHO1 (초음파 1번 에코)                       │
│ PB1         │ PWM (TIM3_CH4 - 부저)                         │
│ PB2         │ LBB (Left Back Backward)                      │
│ PB3         │ TRIG3 (초음파 3번 트리거)                     │
│ PB4         │ TRIG4 (초음파 4번 트리거)                     │
│ PB5         │ LFF (Left Front Forward)                      │
│ PB6         │ LCD_CS (SPI Chip Select)                      │
│ PB7         │ RBF (Right Back Forward)                      │
│ PB8         │ RBB (Right Back Backward)                     │
│ PB9         │ ECHO3 (초음파 3번 에코)                       │
│ PB10        │ ECHO4 (초음파 4번 에코)                       │
│ PB12        │ RFF (Right Front Forward)                     │
│ PB13        │ RFB (Right Front Backward)                    │
├─────────────┼───────────────────────────────────────────────┤
│   GPIOC     │                                               │
├─────────────┼───────────────────────────────────────────────┤
│ PC5         │ FLAME (화염 감지 센서) - EXTI                 │
│ PC6         │ C6 (기울기 센서) - EXTI                       │
│ PC7         │ LED_LEFT                                      │
│ PC8         │ LED_RIGHT                                     │
│ PC9         │ TRIG1 (초음파 1번 트리거)                     │
│ PC13        │ B1 (사용자 버튼)                              │
└─────────────┴───────────────────────────────────────────────┘
```

### 1.3 주변장치 구성

```
┌────────────────────────────────────────────────────────────────────┐
│                        주변장치 블록 다이어그램                     │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐    │
│   │  TIM1   │     │  TIM2   │     │  TIM3   │     │  ADC1   │    │
│   │ (DHT11) │     │(초음파) │     │  (PWM)  │     │ (조도)  │    │
│   │ 1μs tick│     │ 1μs tick│     │  1kHz   │     │ CH10    │    │
│   └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘    │
│        │               │               │               │          │
│   ┌────┴────┐     ┌────┴────┐     ┌────┴────┐     ┌────┴────┐    │
│   │  PA0    │     │ PC9,PB0 │     │   PB1   │     │  PC0    │    │
│   │ DHT11   │     │ TRIG/   │     │  Buzzer │     │  CDS    │    │
│   │         │     │ ECHO×4  │     │         │     │         │    │
│   └─────────┘     └─────────┘     └─────────┘     └─────────┘    │
│                                                                    │
│   ┌─────────┐     ┌─────────┐     ┌─────────────────────────┐    │
│   │  SPI1   │     │ USART2  │     │      Motor Driver       │    │
│   │ (LCD)   │     │(Debug/  │     │   (L298N or TB6612)     │    │
│   │ 16MHz   │     │ BT)     │     │                         │    │
│   └────┬────┘     └────┬────┘     │  LF  RF  LB  RB         │    │
│        │               │          │  ││  ││  ││  ││         │    │
│   ┌────┴────┐     ┌────┴────┐     └──┴┴──┴┴──┴┴──┴┴─────────┘    │
│   │ST7735S  │     │ PA2/PA3 │          4-Wheel Mecanum           │
│   │160×80   │     │ 115200  │                                    │
│   └─────────┘     └─────────┘                                    │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

### 1.4 타이머 설정 상세

| 타이머 | 프리스케일러 | 주기 | 분해능 | 용도 |
|--------|-------------|------|--------|------|
| TIM1 | 63 (64분주) | 65535 | 1μs | DHT11 타이밍 |
| TIM2 | 63 (64분주) | 65535 | 1μs | 초음파 거리 측정 |
| TIM3 | 63 (64분주) | 999 | 1kHz PWM | 부저 제어 |

### 1.5 SPI/UART 설정

**SPI1 (LCD)**
- Mode: Master, Full-Duplex
- Data Size: 8-bit
- Prescaler: 4 → 64MHz/4 = **16MHz**
- CPOL: Low, CPHA: 1Edge (Mode 0)

**USART2 (Debug/Bluetooth)**
- Baudrate: 115200 bps
- Data: 8-bit, No Parity, 1 Stop Bit
- Mode: TX/RX with Interrupt

---

## 2. 소프트웨어 구조 분석

### 2.1 소프트웨어 아키텍처

```
┌────────────────────────────────────────────────────────────────────┐
│                        Application Layer                           │
├────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌───────────┐ │
│  │   Safety     │ │   Motion     │ │   Display    │ │  Sensor   │ │
│  │   Manager    │ │   Control    │ │   Manager    │ │  Handler  │ │
│  │              │ │              │ │              │ │           │ │
│  │ • Tilt Check │ │ • MF/MB/ML/MR│ │ • Expression │ │ • DHT11   │ │
│  │ • Fire Check │ │ • Rotation   │ │ • Color      │ │ • HC-SR04 │ │
│  │ • Emergency  │ │ • Avoid      │ │ • Animation  │ │ • CDS     │ │
│  └──────┬───────┘ └──────┬───────┘ └──────┬───────┘ └─────┬─────┘ │
│         │                │                │               │       │
├─────────┴────────────────┴────────────────┴───────────────┴───────┤
│                         HAL Driver Layer                          │
├────────────────────────────────────────────────────────────────────┤
│    GPIO    │    TIM     │    SPI     │    UART    │    ADC       │
├────────────────────────────────────────────────────────────────────┤
│                      STM32F103 Hardware                           │
└────────────────────────────────────────────────────────────────────┘
```

### 2.2 상태 머신 설계

```
                          ┌─────────────────┐
                          │   POWER ON      │
                          │   Initialize    │
                          └────────┬────────┘
                                   │
                                   ▼
              ┌────────────────────────────────────────┐
              │              NORMAL STATE              │
              │  • UART Command Processing             │
              │  • Periodic Sensor Check               │
              │  • Auto-stop after 200ms               │
              │  • Expression: HAPPY (Blue BG)         │
              └───────┬──────────────┬─────────────────┘
                      │              │
         ┌────────────┴──┐     ┌─────┴─────────────┐
         ▼               ▼     ▼                   ▼
┌─────────────────┐ ┌────────────────┐ ┌─────────────────┐
│  OBSTACLE DET   │ │   TILT DET     │ │   FIRE DET      │
│  (dist < 150mm) │ │  (>2sec tilt)  │ │ (flame sensor)  │
└────────┬────────┘ └───────┬────────┘ └────────┬────────┘
         │                  │                   │
         ▼                  ▼                   ▼
┌─────────────────┐ ┌────────────────┐ ┌─────────────────┐
│  AVOIDING STATE │ │ EMERGENCY STATE│ │   FIRE STATE    │
│                 │ │                │ │                 │
│ Plan 1: 우회전  │ │ • All Stop     │ │ • All Stop      │
│ Plan 2: 좌회전  │ │ • LED ON       │ │ • LED ON        │
│ Plan 3: 후진후  │ │ • Buzzer ON    │ │ • Buzzer ON     │
│         좌회전  │ │ • ANGRY Face   │ │ • ANGRY Face    │
│ Plan 4: 후진    │ │ • Wait Recover │ │ • Wait Clear    │
│                 │ │   (2sec level) │ │   (2sec clear)  │
└────────┬────────┘ └───────┬────────┘ └────────┬────────┘
         │                  │                   │
         │ (dist>350mm)     │ (level 2s)        │ (no flame 2s)
         └──────────────────┴───────────────────┘
                            │
                            ▼
                  ┌─────────────────┐
                  │  RECOVERY TO    │
                  │  NORMAL STATE   │
                  └─────────────────┘
```

### 2.3 메인 루프 실행 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                       MAIN LOOP (while(1))                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ 1. Safety Check (매 루프)                                │  │
│   │    • Check_Tilt_State() → is_emergency 플래그           │  │
│   │    • Check_Fire_State() → is_fire 플래그                │  │
│   │    • Update_Face_Logic() → LCD 표정 업데이트            │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ 2. Emergency/Fire Handler                                │  │
│   │    if (is_emergency || is_fire)                          │  │
│   │       → Stop All Motors                                  │  │
│   │       → Wait for Recovery (Blocking: 20×100ms = 2sec)   │  │
│   │       → continue; (다음 루프로)                          │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ 3. Light Check (2초 주기)                                │  │
│   │    Check_Light() → ADC 읽기 → LED 제어                   │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ 4. Avoidance Check                                       │  │
│   │    if (is_avoiding) → continue;                          │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ 5. Auto-Stop Check (200ms 타임아웃)                      │  │
│   │    if (HAL_GetTick() - last_cmd_time > 200) → ST();      │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ 6. Front Ultrasonic Measurement                          │  │
│   │    trig1() → echo1() → dist1 계산                        │  │
│   │    delay_us(5000)                                        │  │
│   │    trig2() → echo2() → dist2 계산                        │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ 7. Obstacle Avoidance Trigger                            │  │
│   │    if (dist1 < 150 || dist2 < 150)                       │  │
│   │       → Avoid_Obstacle_Routine() (Blocking)              │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ 8. DHT11 Temperature/Humidity (2초 주기)                 │  │
│   │    DHT11_ReadData() → printf()                           │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│                        [Loop Repeat]                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4 인터럽트 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                      Interrupt Hierarchy                        │
├────────────────────┬────────────────────────────────────────────┤
│    Priority        │          Handler                           │
├────────────────────┼────────────────────────────────────────────┤
│     0 (Highest)    │  EXTI9_5_IRQn  - FLAME (PC5), C6 (PC6)    │
│     0              │  EXTI15_10_IRQn - B1 (PC13)               │
│     (Default)      │  USART2_IRQn - UART RX Callback           │
│     (Default)      │  SysTick_IRQn - HAL_GetTick()             │
└────────────────────┴────────────────────────────────────────────┘

UART RX Callback Flow:
┌──────────────────────────────────────────────────────────────┐
│  HAL_UART_RxCpltCallback()                                   │
│  ├─ Echo received byte                                       │
│  ├─ if (NOT avoiding AND NOT emergency AND NOT fire)         │
│  │   ├─ Update last_cmd_time                                 │
│  │   └─ Execute motor command (W/A/S/D/Q/E/Z/C/R/T)         │
│  └─ Re-enable UART Receive IT                                │
└──────────────────────────────────────────────────────────────┘
```

---

## 3. 타이밍 분석

### 3.1 주요 작업별 실행 시간

```
┌──────────────────────────────────────────────────────────────────┐
│                    Execution Time Analysis                       │
├────────────────────────────┬─────────────────────────────────────┤
│ 작업                       │ 예상 실행 시간                      │
├────────────────────────────┼─────────────────────────────────────┤
│ DHT11_ReadData()           │ ~25ms (20ms start + 5ms data)       │
│  ├─ Start Signal           │   20ms (HAL_Delay)                  │
│  ├─ Response Wait          │   ~150μs                            │
│  └─ 40-bit Read            │   ~4.5ms                            │
├────────────────────────────┼─────────────────────────────────────┤
│ Ultrasonic Measurement     │ ~30ms per sensor                    │
│  ├─ Trigger                │   10μs                              │
│  ├─ Echo Wait (max)        │   ~23ms (400cm range)               │
│  └─ Post Delay             │   5-15ms (sensor recovery)          │
├────────────────────────────┼─────────────────────────────────────┤
│ LCD Full Clear             │ ~40-50ms                            │
│  └─ 160×80×2 bytes @16MHz  │   ~25,600 bytes / 2MB/s             │
├────────────────────────────┼─────────────────────────────────────┤
│ Draw_Expression()          │ ~80-120ms (depending on expr)       │
│  ├─ LCD_Clear()            │   ~45ms                             │
│  └─ Eye Drawing            │   ~35-75ms (circles, lines)         │
├────────────────────────────┼─────────────────────────────────────┤
│ ADC Conversion             │ ~2μs                                │
│  └─ 1.5 cycles @10.67MHz   │   ~140ns + overhead                 │
├────────────────────────────┼─────────────────────────────────────┤
│ GPIO Write (HAL)           │ ~500ns-1μs                          │
├────────────────────────────┼─────────────────────────────────────┤
│ printf() 50 chars          │ ~4.3ms @ 115200 baud                │
└────────────────────────────┴─────────────────────────────────────┘
```

### 3.2 메인 루프 사이클 타임 분석

```
Best Case (정상 운행, 장애물 없음):
┌──────────────────────────────────────────────────────────────────┐
│  Check_Tilt_State()    : ~1ms (GPIO read)                       │
│  Check_Fire_State()    : ~1ms (GPIO read)                       │
│  Update_Face_Logic()   : ~0ms (상태 변화 없으면 skip)           │
│  Check_Light()         : ~2ms (every 2s)                        │
│  Ultrasonic×2          : ~60ms (30ms × 2)                       │
│  Printf (debug)        : ~4ms                                   │
│  DHT11 (every 2s)      : ~25ms                                  │
│────────────────────────────────────────────────────────────────│
│  Total Normal Loop     : ~65-95ms (~10-15 Hz)                   │
└──────────────────────────────────────────────────────────────────┘

Worst Case (회피 동작 중):
┌──────────────────────────────────────────────────────────────────┐
│  Avoid_Obstacle_Routine():                                       │
│  ├─ ST() + HAL_Delay(500)           : 500ms                     │
│  ├─ Side Ultrasonic×2 + delay       : ~75ms                     │
│  └─ While Loop per iteration        : ~160ms                    │
│      ├─ Safety Checks               : ~2ms                      │
│      ├─ Update_Face_Logic()         : ~100ms (if changed)       │
│      ├─ Check_Light()               : ~2ms (every 500ms)        │
│      ├─ Front Ultrasonic×2          : ~55ms                     │
│      └─ HAL_Delay(100)              : 100ms                     │
│────────────────────────────────────────────────────────────────│
│  Single Avoid Iteration  : ~660ms minimum                       │
│  Full Avoidance Sequence : 2-5 seconds typical                  │
└──────────────────────────────────────────────────────────────────┘
```

### 3.3 타이밍 병목점 식별

```
┌──────────────────────────────────────────────────────────────────┐
│                    CRITICAL BOTTLENECKS                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. ⚠️ BLOCKING LCD OPERATIONS                                   │
│     ├─ LCD_Clear() : ~45ms blocking                             │
│     ├─ Draw_Expression() : ~80-120ms blocking                   │
│     └─ HAL_SPI_Transmit() : 1 byte at a time (HAL overhead)     │
│                                                                  │
│  2. ⚠️ BLOCKING DELAY IN DHT11                                   │
│     ├─ HAL_Delay(20) in DHT11_Start()                           │
│     └─ Busy-wait loops in DHT11_ReadByte()                      │
│                                                                  │
│  3. ⚠️ BLOCKING ULTRASONIC MEASUREMENT                           │
│     ├─ while() loops waiting for echo                           │
│     ├─ delay_us() between measurements                          │
│     └─ Sequential 4-sensor reading (not parallel)               │
│                                                                  │
│  4. ⚠️ BLOCKING HAL_Delay() IN AVOIDANCE                         │
│     ├─ HAL_Delay(500) at routine start                          │
│     ├─ HAL_Delay(100) in each loop iteration                    │
│     └─ HAL_Delay(100)×20 in recovery check                      │
│                                                                  │
│  5. ⚠️ UART PRINTF BLOCKING                                      │
│     └─ HAL_UART_Transmit() with timeout in printf               │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 3.4 리소스 충돌 분석

```
┌──────────────────────────────────────────────────────────────────┐
│                    RESOURCE CONFLICT MATRIX                      │
├────────────────┬────────────┬────────────┬────────────┬──────────┤
│                │   TIM1     │   TIM2     │    SPI1    │  UART2   │
├────────────────┼────────────┼────────────┼────────────┼──────────┤
│ DHT11 Read     │  USES (μs) │            │            │          │
│ Ultrasonic     │            │  USES (μs) │            │          │
│ LCD Update     │            │            │  USES      │          │
│ Debug Print    │            │            │            │  USES    │
│ UART Callback  │            │            │            │  USES    │
├────────────────┼────────────┼────────────┼────────────┼──────────┤
│ CONFLICT       │ DHT11은    │ 초음파 측정│ LCD 중에   │ Printf와 │
│                │ 인터럽트   │ 중 타이머  │ 인터럽트   │ RX 콜백  │
│                │ 지연 민감  │ 공유 없음  │ 지연 발생  │ 경쟁     │
└────────────────┴────────────┴────────────┴────────────┴──────────┘
```

---

## 4. 최적화 방안

### 4.1 SPI LCD 성능 최적화

**현재 문제점:**
- 1바이트씩 HAL_SPI_Transmit() 호출 → 함수 호출 오버헤드
- CS, DC 토글 빈번 → GPIO 전환 오버헤드
- Blocking 방식으로 CPU 점유

**최적화 방안:**

| 방안 | 예상 개선율 | 구현 난이도 |
|------|-------------|------------|
| DMA 기반 SPI 전송 | 70-80% 시간 절감 | 중간 |
| 버퍼 전송 (16-32 bytes) | 30-40% 개선 | 쉬움 |
| Double Buffering | 50% 병렬화 | 중간 |
| Dirty Rectangle 방식 | 60-90% 감소 (변경부만 갱신) | 쉬움 |

**Dirty Rectangle 개념:**
```
Before (현재):
  표정 변경 → LCD_Clear(전체) → Draw_Expression(전체)
  = 160×80 픽셀 전체 갱신

After (최적화):
  표정 변경 → 변경된 눈 영역만 갱신
  = 눈 영역 (~60×100 픽셀 × 2개) 만 갱신
  ≈ 30-40% 픽셀만 전송
```

### 4.2 초음파 센서 병렬 처리

**현재 문제점:**
- 4개 센서 순차 측정 → 120ms+ 소요
- Busy-wait로 CPU 100% 점유
- 타임아웃 처리가 소프트웨어 카운터 방식

**최적화 방안:**

| 방안 | 설명 | 예상 개선 |
|------|------|----------|
| Input Capture 모드 | TIM의 IC로 에코 펄스 자동 측정 | 하드웨어 기반 측정 |
| Interrupt 기반 | EXTI로 에코 상승/하강 에지 감지 | CPU 유휴 시간 확보 |
| 2채널 동시 측정 | 좌/우 쌍으로 동시 트리거 | 50% 시간 단축 |
| 타임아웃 하드웨어화 | 타이머 인터럽트로 타임아웃 | 안정성 향상 |

**병렬 측정 타이밍:**
```
현재 (Sequential):
  TRIG1 ─┐
         ├─ 30ms ─┤ TRIG2 ─┐
                          ├─ 30ms ─┤ TRIG3 ─┐
                                           ├─ 30ms ─┤ TRIG4 ─┐
                                                            ├─ 30ms
  Total: ~120ms

최적화 (Parallel Pairs):
  TRIG1,3 ─┐
           ├─ 30ms ─┤ TRIG2,4 ─┐
                              ├─ 30ms
  Total: ~60ms (50% 개선)
```

### 4.3 DHT11 비동기 처리

**현재 문제점:**
- HAL_Delay(20ms) 블로킹
- Busy-wait 비트 읽기로 인터럽트 차단
- 메인 루프 주기에 영향

**최적화 방안:**

| 방안 | 구현 방법 |
|------|----------|
| 상태 머신 기반 | DHT11 통신을 여러 상태로 분할, 매 루프에서 상태 진행 |
| Timer 인터럽트 기반 | TIM 인터럽트로 타이밍 제어, 콜백에서 비트 샘플링 |
| 별도 Task 분리 | RTOS 도입 시 별도 태스크로 분리 |

**상태 머신 예시:**
```
DHT11 States:
  IDLE → START_LOW → START_HIGH → WAIT_RESPONSE → 
  READ_BIT_LOW → READ_BIT_HIGH → COMPLETE/ERROR
```

### 4.4 모터 제어 추상화

**현재 문제점:**
- 8개 GPIO 개별 제어로 코드 복잡
- 인라인 코드로 유지보수 어려움
- PWM 속도 제어 미구현

**최적화 방안:**

| 방안 | 효과 |
|------|------|
| 모터 추상화 구조체 | 4륜 독립 제어 간소화 |
| Look-up Table 방식 | 방향별 GPIO 패턴 테이블화 |
| PWM 속도 제어 추가 | TIM3 추가 채널로 속도 조절 |
| Soft-start 구현 | 급가속/급정지 방지 |

### 4.5 소프트웨어 아키텍처 개선

**현재 문제점:**
- Super Loop 구조로 우선순위 제어 불가
- Blocking 함수들로 응답성 저하
- 상태 관리가 전역 플래그에 의존

**최적화 방안:**

| 레벨 | 방안 | 복잡도 |
|------|------|--------|
| 기본 | 협력적 멀티태스킹 (Time-slicing) | 낮음 |
| 중간 | 이벤트 기반 설계 + State Machine | 중간 |
| 고급 | FreeRTOS 도입 | 높음 |

**협력적 멀티태스킹 예시:**
```
Task Scheduler Concept:
┌─────────────────────────────────────────────────────┐
│  while(1) {                                         │
│    Task_Safety();      // 매번 (우선순위 높음)     │
│    if (tick % 10 == 0) Task_Ultrasonic();          │
│    if (tick % 20 == 0) Task_LCD();                 │
│    if (tick % 100 == 0) Task_DHT11_Step();         │
│    if (tick % 200 == 0) Task_Light();              │
│    tick++;                                          │
│  }                                                  │
└─────────────────────────────────────────────────────┘
```

### 4.6 UART 최적화

**현재 문제점:**
- printf()가 Blocking HAL_UART_Transmit() 사용
- 디버그 출력이 실시간 성능에 영향

**최적화 방안:**

| 방안 | 구현 |
|------|------|
| DMA TX 사용 | HAL_UART_Transmit_DMA()로 비동기 전송 |
| Ring Buffer 도입 | 송신 버퍼에 쌓고 DMA로 전송 |
| 조건부 컴파일 | DEBUG_PRINT 매크로로 릴리즈 시 제거 |
| 로그 레벨 도입 | 중요도별 출력 필터링 |

### 4.7 전력 최적화 (선택적)

| 방안 | 절감 효과 |
|------|----------|
| Sleep Mode 활용 | Idle 시 __WFI() 사용 |
| 클럭 게이팅 | 미사용 주변장치 클럭 차단 |
| GPIO 최적화 | 미사용 핀 아날로그 모드 설정 |
| 센서 Power Control | 측정 시에만 센서 전원 공급 |

---

## 5. 우선순위별 최적화 로드맵

### Phase 1: Quick Wins (1-2일)

| 항목 | 작업 | 예상 효과 |
|------|------|----------|
| 1 | LCD Dirty Rectangle 적용 | 표정 변경 시간 50% 감소 |
| 2 | SPI 버퍼 전송 (16byte) | LCD 전송 30% 가속 |
| 3 | 불필요한 HAL_Delay 축소 | 루프 시간 단축 |
| 4 | DEBUG 매크로 도입 | 릴리즈 성능 향상 |

### Phase 2: Medium Term (1주)

| 항목 | 작업 | 예상 효과 |
|------|------|----------|
| 1 | 초음파 Input Capture 도입 | CPU 유휴 시간 확보 |
| 2 | UART DMA TX 적용 | printf 비동기화 |
| 3 | 협력적 스케줄러 도입 | 응답성 개선 |
| 4 | 모터 제어 추상화 | 코드 가독성 향상 |

### Phase 3: Long Term (2-4주)

| 항목 | 작업 | 예상 효과 |
|------|------|----------|
| 1 | SPI DMA 적용 | LCD 성능 극대화 |
| 2 | DHT11 상태 머신화 | 완전 비동기 처리 |
| 3 | FreeRTOS 도입 검토 | 확장성 확보 |
| 4 | 전력 관리 구현 | 배터리 효율 향상 |

---

## 6. 참고 정보

### 6.1 측정 기준

모든 타이밍 값은 이론적 계산 또는 일반적인 HAL 드라이버 오버헤드 기준이며, 실제 측정 시 GPIO 토글 + 오실로스코프 또는 DWT 사이클 카운터를 활용한 프로파일링을 권장합니다.

### 6.2 하드웨어 의존성

- 초음파 센서 타이밍은 HC-SR04 기준
- LCD 타이밍은 ST7735S 160×80 기준
- 모터 드라이버는 H-Bridge 방식 (L298N/TB6612) 가정

### 6.3 추가 고려사항

| 항목 | 현재 상태 | 권장 사항 |
|------|----------|----------|
| Watchdog | 미사용 | IWDG 활성화 권장 |
| Error Handler | 무한 루프 | 시스템 리셋 또는 복구 로직 추가 |
| Stack Overflow | 체크 없음 | MPU 또는 스택 가드 패턴 도입 |
| EMI 대책 | 미구현 | 모터 노이즈 필터링 회로 검토 |

---

*문서 작성일: 2025-01-28*  
*대상 펌웨어: Smart Guard Rover with LCD & DHT11*  
*MCU: STM32F103 @ 64MHz*
