# STM32F103 Smart Grip Car - 시스템 분석 문서

## 📋 목차
1. [프로젝트 개요](#1-프로젝트-개요)
2. [하드웨어 구조 분석](#2-하드웨어-구조-분석)
3. [소프트웨어 구조 분석](#3-소프트웨어-구조-분석)
4. [타이밍 분석](#4-타이밍-분석)
5. [최적화 방안](#5-최적화-방안)

---

## 1. 프로젝트 개요

### 1.1 시스템 설명
이 프로젝트는 STM32F103 마이크로컨트롤러 기반의 **Smart Grip Car** 시스템으로, 4륜 메카넘/옴니휠 로봇에 그리퍼(집게) 기능을 추가한 원격 제어 차량입니다.

### 1.2 주요 기능
| 기능 | 설명 |
|------|------|
| 4륜 구동 제어 | 전진, 후진, 좌/우회전, 대각선 이동 |
| 그리퍼 제어 | 2축 서보 모터를 이용한 물체 잡기/놓기 |
| 거리 측정 | HC-SR04 초음파 센서로 장애물 감지 |
| 조도 측정 | CDS 센서로 주변 밝기 감지 |
| 디스플레이 | I2C LCD에 거리 정보 및 게이지바 표시 |
| 원격 제어 | UART를 통한 시리얼 명령 수신 |

### 1.3 명령어 체계
```
이동 제어:  W(전진), S(후진), A(좌회전), D(우회전), X(정지)
대각선:     Q(좌전방), E(우전방), Z(좌후방), C(우후방)
그리퍼:     U(잡기), I(놓기), Y(홈 위치)
```

---

## 2. 하드웨어 구조 분석

### 2.1 MCU 사양
```
┌─────────────────────────────────────────────────────────┐
│              STM32F103C8T6 (Blue Pill)                  │
├─────────────────────────────────────────────────────────┤
│  Core:        ARM Cortex-M3                             │
│  Clock:       64 MHz (HSI 8MHz × PLL 16 ÷ 2)           │
│  Flash:       64 KB                                     │
│  SRAM:        20 KB                                     │
│  GPIO:        37 pins                                   │
└─────────────────────────────────────────────────────────┘
```

### 2.2 클록 트리 구조
```
HSI (8 MHz)
    │
    ├──÷2──► PLL Source (4 MHz)
    │            │
    │            ×16
    │            │
    │            ▼
    │        PLL Output (64 MHz)
    │            │
    │            ▼
    └────────► SYSCLK = 64 MHz
                 │
    ┌────────────┼────────────┐
    │            │            │
    ▼            ▼            ▼
  AHB         APB1         APB2
 64 MHz      32 MHz       64 MHz
    │            │            │
    ▼            ▼            ▼
  Core      TIM2,TIM3      TIM1
  DMA       I2C1,UART2     ADC1
  Memory
```

### 2.3 주변장치 핀 매핑

#### 2.3.1 모터 드라이버 연결 (8개 GPIO)
```
┌──────────────────────────────────────────────────────────┐
│                    4륜 모터 배치                          │
│                                                          │
│    [LF]─────────────────────────────[RF]                │
│     │    Left Front    Right Front    │                 │
│     │                                 │                 │
│     │         ┌─────────┐            │                 │
│     │         │  MCU    │            │                 │
│     │         └─────────┘            │                 │
│     │                                 │                 │
│    [LB]─────────────────────────────[RB]                │
│          Left Back      Right Back                      │
└──────────────────────────────────────────────────────────┘

GPIO 할당:
├── Left Front  : LFF(PB3), LFB(PA12)
├── Left Back   : LBF(PC13), LBB(PB4)  
├── Right Front : RFF(PB5), RFB(PB10)
└── Right Back  : RBF(PB0), RBB(PB1)
```

#### 2.3.2 전체 핀 할당 테이블
| 기능 | 핀 | 포트 | 모드 | 비고 |
|------|-----|------|------|------|
| **UART2_TX** | PA2 | GPIOA | AF_PP | 디버그/제어 |
| **UART2_RX** | PA3 | GPIOA | Input | 명령 수신 |
| **I2C1_SCL** | PB6 | GPIOB | AF_OD | LCD 통신 |
| **I2C1_SDA** | PB7 | GPIOB | AF_OD | LCD 통신 |
| **TIM2_CH1** | PA0 | GPIOA | AF_PP | 서보 PWM (Right) |
| **TIM3_CH1** | PA6 | GPIOA | AF_PP | 서보 PWM (Left) |
| **ADC1_CH10** | PC0 | GPIOC | Analog | CDS 센서 |
| **TRIG1** | PC7 | GPIOC | Output | 초음파 트리거 |
| **ECHO1** | PA8 | GPIOA | Input | 초음파 에코 |
| **LED1** | PC8 | GPIOC | Output | 상태 LED |
| **LED2** | PC9 | GPIOC | Output | 상태 LED |

### 2.4 타이머 설정 상세

```
┌─────────────────────────────────────────────────────────────┐
│                    타이머 구성                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  TIM1 (초음파 시간 측정용)                                    │
│  ├── Clock: 64 MHz (APB2)                                   │
│  ├── Prescaler: 63                                          │
│  ├── Counter Clock: 64MHz/(63+1) = 1 MHz                    │
│  ├── Period: 65535                                          │
│  ├── Resolution: 1 µs/tick                                  │
│  └── Max Range: 65.535 ms                                   │
│                                                             │
│  TIM2 (서보 PWM - Right Gripper)                            │
│  ├── Clock: 64 MHz (APB1 × 2, APB1 Prescaler ≠ 1)          │
│  ├── Prescaler: 1279                                        │
│  ├── Counter Clock: 64MHz/(1279+1) = 50 kHz                │
│  ├── Period: 999                                            │
│  ├── PWM Frequency: 50kHz/(999+1) = 50 Hz                  │
│  └── PWM Period: 20 ms (서보 표준)                          │
│                                                             │
│  TIM3 (서보 PWM - Left Gripper)                             │
│  ├── 설정: TIM2와 동일                                       │
│  └── PWM Frequency: 50 Hz                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.5 서보 모터 듀티 사이클 계산
```
Period = 1000 ticks (0~999)
PWM Period = 20ms

Position Values:
├── MIN (0°)   : 25  → 25/1000 × 20ms = 0.5ms
├── CENTER(90°): 75  → 75/1000 × 20ms = 1.5ms  
└── MAX (180°) : 125 → 125/1000 × 20ms = 2.5ms

Duty Cycle Range: 2.5% ~ 12.5%
```

### 2.6 시스템 블록 다이어그램
```
                              ┌─────────────┐
                              │   UART      │
                              │  (PC/BT)    │
                              └──────┬──────┘
                                     │ 115200 bps
                                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                        STM32F103C8T6                            │
│                                                                 │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐        │
│  │  TIM1   │   │  TIM2   │   │  TIM3   │   │  ADC1   │        │
│  │(Counter)│   │  (PWM)  │   │  (PWM)  │   │         │        │
│  └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘        │
│       │             │             │             │              │
│  ┌────┴────┐   ┌────┴────┐   ┌────┴────┐   ┌────┴────┐        │
│  │  GPIO   │   │  GPIO   │   │  GPIO   │   │  GPIO   │        │
│  │(8 Motor)│   │ (Servo) │   │ (Servo) │   │  (ADC)  │        │
│  └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘        │
│       │             │             │             │              │
│       │        ┌────┴────┐   ┌────┴────┐        │              │
│       │        │   I2C   ├───┤  USART  │        │              │
│       │        └────┬────┘   └────┬────┘        │              │
└───────┼─────────────┼─────────────┼─────────────┼──────────────┘
        │             │             │             │
        ▼             ▼             ▼             ▼
┌───────────────┐ ┌───────┐   ┌───────────┐ ┌─────────┐
│  Motor Driver │ │ I2C   │   │  HC-SR04  │ │   CDS   │
│   (L298N×2)   │ │ LCD   │   │ Ultrasonic│ │ Sensor  │
│               │ │(PCF)  │   │           │ │         │
│ LF LB RF RB   │ │       │   │ TRIG ECHO │ │         │
└───────────────┘ └───────┘   └───────────┘ └─────────┘
        │             │             │             │
        ▼             ▼             ▼             ▼
   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐
   │ 4×DC    │   │ 16×2    │   │ 거리    │   │ 조도    │
   │ Motors  │   │ LCD     │   │ 측정    │   │ 측정    │
   └─────────┘   └─────────┘   └─────────┘   └─────────┘
```

---

## 3. 소프트웨어 구조 분석

### 3.1 소프트웨어 아키텍처
```
┌─────────────────────────────────────────────────────────────────┐
│                     Application Layer                           │
├─────────────────────────────────────────────────────────────────┤
│  Motor Control  │  Servo Control  │  Sensor Read  │  Display   │
│  Forward()      │  Grip/Release   │  trig()/echo()│  LCD_*()   │
│  Backward()     │  PWM Update     │  ADC Read     │  Gauge     │
│  Left()/Right() │                 │               │            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    HAL (Hardware Abstraction Layer)             │
├─────────────────────────────────────────────────────────────────┤
│  HAL_GPIO_*     │  HAL_TIM_*      │  HAL_I2C_*    │  HAL_UART_* │
│  HAL_ADC_*      │  HAL_Delay      │               │             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    CMSIS / Register Layer                       │
├─────────────────────────────────────────────────────────────────┤
│  RCC Registers  │  GPIO Registers │  TIM Registers│  Peripheral │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Hardware (STM32F103)                         │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 메인 루프 실행 흐름
```
main()
  │
  ├── HAL_Init()
  ├── SystemClock_Config()        ← 64MHz 설정
  ├── MX_*_Init()                 ← 주변장치 초기화
  │     ├── GPIO
  │     ├── USART2 (115200 bps)
  │     ├── I2C1 (100 kHz)
  │     ├── TIM1 (1µs resolution)
  │     ├── TIM2 (50Hz PWM)
  │     ├── TIM3 (50Hz PWM)
  │     └── ADC1
  │
  ├── HAL_TIM_Base_Start(&htim1)
  ├── I2C_ScanAddresses()
  ├── LCD_INIT()
  ├── HAL_TIM_PWM_Start()         ← 서보 PWM 시작
  ├── HAL_ADCEx_Calibration_Start()
  │
  └── while(1)  ─────────────────────────────────────┐
        │                                            │
        ├── [1] 초음파 거리 측정                      │
        │     ├── trig()          ~12µs              │
        │     └── echo()          ~0-30ms (거리 의존) │
        │                                            │
        ├── [2] LCD 출력                              │
        │     ├── sprintf()                          │
        │     ├── printf()        ~1ms (blocking)    │
        │     ├── LCD_XY() + LCD_PUTS()              │
        │     └── LCD_DrawGauge() ~10-20ms (I2C)     │
        │                                            │
        ├── [3] UART 명령 수신                        │
        │     └── HAL_UART_Receive() 1ms timeout     │
        │                                            │
        ├── [4] 명령 처리                             │
        │     ├── 모터 제어 (GPIO Write)              │
        │     └── 서보 위치 업데이트 (PWM)            │
        │                                            │
        ├── [5] ADC 조도 측정                         │
        │     ├── HAL_ADC_Start()                    │
        │     ├── HAL_ADC_PollForConversion()        │
        │     ├── printf() 결과 출력                 │
        │     └── HAL_ADC_Stop()                     │
        │                                            │
        └── [6] HAL_Delay(5)      ←────────────────┘
```

### 3.3 함수 계층 구조
```
┌─────────────────────────────────────────────────────────────┐
│                    Motor Control Functions                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  High-Level          Mid-Level           Low-Level          │
│  ┌─────────┐        ┌─────────┐         ┌─────────────┐    │
│  │ Forward │───────►│   RF    │────────►│HAL_GPIO_    │    │
│  │ Backward│        │   LF    │         │  WritePin() │    │
│  │ Left    │        │   RB    │         └─────────────┘    │
│  │ Right   │        │   LB    │                            │
│  │ Stop    │        └─────────┘                            │
│  └─────────┘                                               │
│       │                                                    │
│       ▼                                                    │
│  ┌─────────┐        ┌─────────┐                           │
│  │  TRF    │───────►│ RF(dir) │  dir: 0=stop, 1=fwd, 2=bwd│
│  │  TLF    │        │ LF(dir) │                           │
│  │  TRB    │        │ RB(dir) │                           │
│  │  TLB    │        │ LB(dir) │                           │
│  └─────────┘        └─────────┘                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    LCD Control Functions                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Application        Driver              HAL                 │
│  ┌───────────┐     ┌───────────┐      ┌─────────────┐     │
│  │LCD_PUTS() │────►│LCD_DATA() │─────►│HAL_I2C_     │     │
│  │LCD_XY()   │     │LCD_CMD()  │      │Master_      │     │
│  │LCD_CLEAR()│     │LCD_CMD_   │      │Transmit()   │     │
│  │LCD_INIT() │     │  4bit()   │      └─────────────┘     │
│  │LCD_Draw   │     └───────────┘                          │
│  │  Gauge()  │           │                                │
│  └───────────┘           ▼                                │
│                    ┌───────────┐                          │
│                    │ delay_us()│  소프트웨어 딜레이        │
│                    └───────────┘                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  Ultrasonic Sensor Functions                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────┐                                             │
│  │  trig()   │──► GPIO High(10µs) ──► GPIO Low             │
│  └───────────┘                                             │
│                                                             │
│  ┌───────────┐     ┌────────────────────────────────┐     │
│  │  echo()   │────►│ Wait ECHO Rising Edge          │     │
│  │           │     │ Start Timer Count              │     │
│  │           │     │ Wait ECHO Falling Edge         │     │
│  │           │     │ Return Timer Difference        │     │
│  └───────────┘     └────────────────────────────────┘     │
│                              │                             │
│                              ▼                             │
│                    __HAL_TIM_GET_COUNTER(&htim1)           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.4 데이터 흐름 분석
```
┌──────────────────────────────────────────────────────────────┐
│                      Data Flow Diagram                       │
└──────────────────────────────────────────────────────────────┘

[Ultrasonic Sensor]
     │
     ▼
  echo_time (µs)
     │
     ├──► dist = echo_time / 58  ──► [LCD Display]
     │                               "Dist: XXX cm"
     │                                    │
     │                                    ▼
     │                              [Gauge Bar]
     │                               ████████░░░░░░░░
     │
     └──► [UART Output] ──► PC Terminal

[CDS Sensor]
     │
     ▼
  adc_value (0-4095)
     │
     ├──► voltage = adc_value × 3.3 / 4095
     │
     ├──► Light Level Classification
     │     ├── < 0.5V : Very Dark
     │     ├── < 1.0V : Dark
     │     ├── < 2.0V : Medium  ──► LED1=OFF, LED2=ON
     │     ├── < 2.5V : Bright
     │     └── ≥ 2.5V : Very Bright ──► LED1=OFF, LED2=OFF
     │
     └──► [UART Output]

[UART RX]
     │
     ▼
  rx_data (1 byte)
     │
     ├──► Motor Command ──► GPIO Write (8 pins)
     │     w/s/a/d/x/q/e/z/c
     │
     └──► Servo Command ──► PWM Duty Update
           u/i/y              │
                              ▼
                         pos_left, pos_right
                              │
                              ▼
                    __HAL_TIM_SET_COMPARE()
```

### 3.5 상태 변수 관리
```c
// 전역 상태 변수
┌─────────────────────────────────────────────────┐
│ Variable        │ Type     │ Purpose            │
├─────────────────────────────────────────────────┤
│ rx_data         │ uint8_t  │ UART 수신 버퍼      │
│ echo_time       │ uint32_t │ 초음파 펄스 시간    │
│ dist            │ int      │ 계산된 거리 (cm)    │
│ lcd_buf[20]     │ char[]   │ LCD 출력 버퍼       │
│ pos_right       │ uint8_t  │ 우측 서보 위치      │
│ pos_left        │ uint8_t  │ 좌측 서보 위치      │
│ adc_value       │ uint32_t │ ADC 원시값          │
│ voltage         │ float    │ 변환된 전압         │
└─────────────────────────────────────────────────┘
```

---

## 4. 타이밍 분석

### 4.1 메인 루프 시간 분석

#### 4.1.1 각 단계별 예상 실행 시간
```
┌──────────────────────────────────────────────────────────────────┐
│                    Main Loop Timing Breakdown                    │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Task                          │  Min Time  │  Max Time  │ Note │
│  ─────────────────────────────────────────────────────────────── │
│  [1] 초음파 측정                                                  │
│      ├── trig()                │   12 µs   │    12 µs   │       │
│      └── echo() polling        │   ~100 µs │   ~30 ms   │ ★    │
│                                                                  │
│  [2] LCD 출력                                                     │
│      ├── sprintf()             │   ~10 µs  │   ~20 µs   │       │
│      ├── printf() blocking     │   ~870 µs │   ~1 ms    │ ★    │
│      ├── LCD_XY() + LCD_PUTS() │   ~5 ms   │   ~10 ms   │ ★★   │
│      └── LCD_DrawGauge()       │   ~10 ms  │   ~20 ms   │ ★★★  │
│                                                                  │
│  [3] UART 수신                                                    │
│      └── HAL_UART_Receive()    │   ~50 µs  │   1 ms     │       │
│                                                                  │
│  [4] 명령 처리                                                    │
│      ├── GPIO Write (motor)    │   ~1 µs   │   ~5 µs    │       │
│      └── PWM Update            │   ~1 µs   │   ~2 µs    │       │
│                                                                  │
│  [5] ADC 조도 측정                                                │
│      ├── HAL_ADC_Start()       │   ~5 µs   │   ~10 µs   │       │
│      ├── PollForConversion()   │   ~15 µs  │   ~50 µs   │       │
│      ├── printf() × 2-3회      │   ~2 ms   │   ~3 ms    │ ★★   │
│      └── HAL_ADC_Stop()        │   ~5 µs   │   ~10 µs   │       │
│                                                                  │
│  [6] HAL_Delay(5)              │   5 ms    │   5 ms     │       │
│  ─────────────────────────────────────────────────────────────── │
│  Total Loop Time (estimated)   │  ~25 ms   │  ~70 ms    │       │
│  Loop Frequency                │  ~14 Hz   │  ~40 Hz    │       │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

★    = 주요 병목 지점
★★   = 심각한 병목 지점
★★★  = 가장 심각한 병목 지점
```

#### 4.1.2 I2C LCD 통신 시간 상세 분석
```
I2C 통신 파라미터:
├── Clock Speed: 100 kHz (Standard Mode)
├── 1 byte 전송: ~90 µs (Start + 8bit + ACK)
└── 1 command/data: 4 bytes (Upper nibble + Lower nibble)

LCD 1문자 출력 시간:
├── LCD_DATA() = 4 × I2C transmit = ~360 µs
├── + delay_us(50) = ~150 µs (실제는 3배)
└── Total per char: ~510 µs

"Dist: XXX cm" (12문자) 출력:
└── 12 × 510 µs = ~6.1 ms

게이지바 (16문자) 출력:
└── 16 × 510 µs = ~8.2 ms

LCD_XY() 명령:
└── LCD_CMD() = ~510 µs × 2회 = ~1 ms
```

### 4.2 인터럽트 레이턴시 분석
```
┌──────────────────────────────────────────────────────────────────┐
│                    Interrupt Latency Analysis                    │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  현재 설정된 인터럽트:                                             │
│  ├── EXTI15_10 (PC13: B1_Pin 또는 LBF_Pin)                       │
│  │     └── Priority: 0,0 (최고 우선순위)                          │
│  │                                                               │
│  └── SysTick (HAL_Delay 용)                                      │
│        └── 1ms 주기                                              │
│                                                                  │
│  문제점:                                                          │
│  ├── UART 수신: 폴링 방식 → 명령 누락 가능                        │
│  ├── 초음파 에코: 폴링 방식 → CPU 점유                            │
│  └── I2C 통신: 블로킹 방식 → 응답성 저하                          │
│                                                                  │
│  Worst-case 인터럽트 응답 시간:                                    │
│  └── HAL_I2C_Master_Transmit() 블로킹 중: ~1ms                   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 4.3 UART 통신 타이밍
```
UART 설정:
├── Baud Rate: 115200 bps
├── Word Length: 8 bits
├── Stop Bits: 1
└── Parity: None

1문자 전송 시간:
└── (1 start + 8 data + 1 stop) / 115200 = ~87 µs

printf() 문자열 전송:
├── "Dist: XXX cm\r\n" (14 chars) = ~1.2 ms
├── "pos_right: XX, pos_left: XX\r\n" (30 chars) = ~2.6 ms
└── Light level 출력 = ~0.5-1 ms

문제점:
└── HAL_UART_Transmit()는 블로킹 함수
    → printf() 호출마다 CPU 대기
```

### 4.4 초음파 센서 타이밍 분석
```
HC-SR04 동작 원리:
├── Trigger Pulse: 10µs (최소)
├── Ranging: 음파 왕복 시간 측정
└── Echo Pulse Width: 거리 비례

거리 계산:
├── 음속: ~343 m/s @ 20°C
├── 왕복 거리: distance × 2
└── Time = Distance × 2 / 343000 mm/ms
    Distance (cm) = Time (µs) / 58

측정 범위와 시간:
├── 2 cm   →  ~116 µs
├── 10 cm  →  ~580 µs
├── 100 cm →  ~5.8 ms
├── 400 cm →  ~23.2 ms (최대 범위)
└── Timeout: 30 ms 설정 권장

현재 코드 문제:
└── timeout = 50000 반복문
    → 실제 타임아웃 시간 불명확 (클록 의존적)
```

### 4.5 PWM 서보 제어 타이밍
```
서보 모터 특성:
├── PWM 주기: 20 ms (50 Hz)
├── 펄스 폭 범위: 0.5 ms ~ 2.5 ms
└── 위치 응답 시간: ~100-300 ms (서보 의존)

PWM 업데이트 레이턴시:
├── __HAL_TIM_SET_COMPARE(): ~수 µs
└── 실제 서보 반영: 최대 1 PWM 주기 (20 ms)

그리퍼 동작:
├── HOLD (잡기):   left=55, right=95
├── RELEASE (놓기): left=95, right=55  
└── HOME (중립):   left=75, right=75

위치 차이: 40 ticks = 0.8 ms pulse 변화
→ 서보 회전량: ~36° (서보에 따라 다름)
```

---

## 5. 최적화 방안

### 5.1 우선순위별 최적화 항목

```
┌──────────────────────────────────────────────────────────────────┐
│              Optimization Priority Matrix                        │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Impact                                                          │
│    ▲                                                            │
│    │   ┌─────────────────────────────────────────────┐          │
│  High │ │ [P1] UART 인터럽트화    │ [P2] I2C DMA      │          │
│    │   │      응답성 대폭 향상   │     LCD 병목 해소  │          │
│    │   └─────────────────────────────────────────────┘          │
│    │   ┌─────────────────────────────────────────────┐          │
│  Med │  │ [P3] Timer Capture      │ [P4] 선택적 출력  │          │
│    │   │      초음파 정확도 향상  │     불필요 연산 제거│         │
│    │   └─────────────────────────────────────────────┘          │
│    │   ┌─────────────────────────────────────────────┐          │
│  Low │  │ [P5] delay_us 개선      │ [P6] 코드 구조화   │         │
│    │   │      타이밍 정확도 향상  │     유지보수성 향상 │         │
│    │   └─────────────────────────────────────────────┘          │
│    │                                                            │
│    └────────────────────────────────────────────────►           │
│              Effort (Low ──────────────────► High)              │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 5.2 [P1] UART 인터럽트 기반 수신

#### 현재 문제점
```
현재 방식: Polling with 1ms timeout
├── 매 루프마다 HAL_UART_Receive() 호출
├── 루프 주기(~25-70ms) 동안 명령 누락 가능
└── Timeout 대기로 인한 CPU 낭비
```

#### 개선 방향
```
개선 방식: Interrupt + Ring Buffer

┌─────────────────────────────────────────────────────────────┐
│  HAL_UART_Receive_IT() 사용                                 │
│  ├── 수신 인터럽트 활성화                                    │
│  ├── 콜백에서 Ring Buffer에 저장                            │
│  └── 메인 루프에서 버퍼 확인 (Non-blocking)                  │
└─────────────────────────────────────────────────────────────┘

예상 효과:
├── 명령 누락 방지 (100% 수신 보장)
├── CPU 점유율 감소
└── 응답 레이턴시: 루프 주기 → 인터럽트 레이턴시 (~µs)
```

### 5.3 [P2] I2C DMA 전송

#### 현재 문제점
```
현재 방식: Blocking I2C Transmit
├── HAL_I2C_Master_Transmit() 반복 호출
├── 매 호출 시 전송 완료까지 대기
└── LCD 출력에 ~15-30ms 소요 (메인 루프의 40-60%)
```

#### 개선 방향
```
개선 방식: DMA + Double Buffer

┌─────────────────────────────────────────────────────────────┐
│  1. LCD 명령을 버퍼에 준비 (배경)                            │
│  2. DMA로 I2C 전송 시작 (Non-blocking)                       │
│  3. 전송 완료 인터럽트에서 다음 데이터 전송                   │
│  4. 메인 루프는 다른 작업 수행                               │
└─────────────────────────────────────────────────────────────┘

예상 효과:
├── LCD 출력 중 CPU 해방
├── 메인 루프 시간: ~25ms → ~10ms (2배 이상 개선)
└── 실시간성 대폭 향상
```

### 5.4 [P3] 초음파 센서 Timer Input Capture

#### 현재 문제점
```
현재 방식: Polling Echo Pin
├── while() 루프로 에코 핀 상태 대기
├── 최대 ~30ms CPU 점유
├── timeout 변수로 부정확한 타임아웃
└── 측정 중 다른 작업 불가
```

#### 개선 방향
```
개선 방식: Timer Input Capture Mode

┌─────────────────────────────────────────────────────────────┐
│  TIM1을 Input Capture 모드로 설정                           │
│  ├── CH1: Echo Rising Edge Capture                          │
│  ├── CH2: Echo Falling Edge Capture (또는 CH1 Both Edges)  │
│  └── 인터럽트에서 시간 차이 계산                             │
└─────────────────────────────────────────────────────────────┘

동작 흐름:
1. Trigger 펄스 출력
2. CPU는 다른 작업 수행
3. Echo Rising → capture1 저장 (인터럽트)
4. Echo Falling → capture2 저장, 거리 계산 (인터럽트)

예상 효과:
├── 측정 중 CPU 100% 해방
├── 측정 정확도 향상 (하드웨어 타임스탬프)
└── 여러 초음파 센서 동시 측정 가능
```

### 5.5 [P4] 선택적 출력 및 조건부 업데이트

#### 현재 문제점
```
현재 방식: 매 루프 전체 출력
├── 거리 변화 없어도 LCD 전체 갱신
├── 매 루프 printf() 다수 호출
└── 불필요한 I2C/UART 트래픽
```

#### 개선 방향
```
개선 방식: Change Detection + Selective Update

┌─────────────────────────────────────────────────────────────┐
│  // 변경 감지 후 선택적 업데이트                              │
│  static int last_dist = -1;                                 │
│  static int last_light = -1;                                │
│                                                             │
│  if (abs(dist - last_dist) > THRESHOLD) {                   │
│      LCD_UpdateDistance(dist);  // 거리 부분만 갱신          │
│      last_dist = dist;                                      │
│  }                                                          │
│                                                             │
│  // 디버그 출력은 조건부로                                   │
│  #ifdef DEBUG_PRINT                                         │
│      printf("Dist: %d\n", dist);                            │
│  #endif                                                     │
└─────────────────────────────────────────────────────────────┘

예상 효과:
├── LCD 갱신 빈도 50-80% 감소
├── UART 트래픽 대폭 감소
└── 루프 시간 단축
```

### 5.6 [P5] delay_us() 함수 개선

#### 현재 문제점
```c
// 현재 구현
void delay_us(int us){
    value = 3;
    delay = us * value;
    for(int i=0; i < delay; i++);  // 빈 루프
}

문제점:
├── 컴파일러 최적화로 제거될 수 있음
├── 클록 속도 변경 시 재보정 필요
├── 정확도 낮음 (인터럽트 영향)
└── CPU 100% 점유
```

#### 개선 방향
```
개선 방식 1: DWT Cycle Counter (권장)

┌─────────────────────────────────────────────────────────────┐
│  // DWT (Data Watchpoint and Trace) 사용                    │
│  CoreDebug->DEMCR |= CoreDebug_DEMCR_TRCENA_Msk;           │
│  DWT->CYCCNT = 0;                                          │
│  DWT->CTRL |= DWT_CTRL_CYCCNTENA_Msk;                      │
│                                                             │
│  void delay_us_dwt(uint32_t us) {                          │
│      uint32_t start = DWT->CYCCNT;                         │
│      uint32_t cycles = us * (SystemCoreClock / 1000000);   │
│      while ((DWT->CYCCNT - start) < cycles);               │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘

개선 방식 2: Timer 기반 (대안)

┌─────────────────────────────────────────────────────────────┐
│  // 전용 타이머 사용 (TIM4 등)                               │
│  void delay_us_tim(uint16_t us) {                          │
│      __HAL_TIM_SET_COUNTER(&htim4, 0);                     │
│      while (__HAL_TIM_GET_COUNTER(&htim4) < us);           │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘

예상 효과:
├── 정확도: ±10% → ±1% 이하
├── 재현성 보장
└── 컴파일러 최적화 영향 없음
```

### 5.7 [P6] 소프트웨어 구조 개선

#### 태스크 기반 구조
```
┌─────────────────────────────────────────────────────────────┐
│              Task-based Architecture                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ Sensor Task │  │ Motor Task  │  │Display Task │        │
│  │   10 Hz     │  │   50 Hz     │  │   5 Hz      │        │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │
│         │                │                │                │
│         ▼                ▼                ▼                │
│  ┌─────────────────────────────────────────────────┐      │
│  │              Cooperative Scheduler               │      │
│  │  (SysTick 기반 시분할 또는 FreeRTOS)             │      │
│  └─────────────────────────────────────────────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 주기적 태스크 실행
```c
// 개선된 메인 루프 개념

typedef struct {
    uint32_t period_ms;     // 실행 주기
    uint32_t last_run;      // 마지막 실행 시간
    void (*task_func)(void); // 태스크 함수
} Task_t;

Task_t tasks[] = {
    {100, 0, Task_Ultrasonic},  // 10 Hz
    {200, 0, Task_LCD},         // 5 Hz  
    {20,  0, Task_Motor},       // 50 Hz
    {500, 0, Task_ADC},         // 2 Hz
};

// Scheduler
while(1) {
    uint32_t now = HAL_GetTick();
    for (int i = 0; i < NUM_TASKS; i++) {
        if (now - tasks[i].last_run >= tasks[i].period_ms) {
            tasks[i].task_func();
            tasks[i].last_run = now;
        }
    }
    // UART 처리는 인터럽트 기반으로 분리
}
```

### 5.8 최적화 적용 우선순위 로드맵

```
┌──────────────────────────────────────────────────────────────────┐
│                    Implementation Roadmap                        │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Phase 1: Quick Wins (1-2일)                                     │
│  ├── [P4] 선택적 출력 구현                                       │
│  ├── [P5] delay_us DWT 개선                                      │
│  └── 예상 효과: 루프 시간 30% 단축                                │
│                                                                  │
│  Phase 2: Core Improvements (3-5일)                              │
│  ├── [P1] UART 인터럽트 + Ring Buffer                            │
│  ├── [P3] Timer Input Capture for Ultrasonic                    │
│  └── 예상 효과: 응답성 10배 이상 개선                             │
│                                                                  │
│  Phase 3: Advanced Optimization (1주)                            │
│  ├── [P2] I2C DMA 전송                                          │
│  ├── [P6] 태스크 스케줄러 도입                                   │
│  └── 예상 효과: 실시간 멀티태스킹 가능                            │
│                                                                  │
│  Phase 4: Production Ready (선택)                                │
│  ├── FreeRTOS 도입 검토                                         │
│  ├── 전력 최적화 (Sleep 모드)                                    │
│  └── Watchdog 및 오류 복구                                       │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 5.9 최적화 전후 예상 성능 비교

```
┌──────────────────────────────────────────────────────────────────┐
│                Performance Comparison                            │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Metric              │  Before    │  After      │  Improvement  │
│  ────────────────────────────────────────────────────────────── │
│  Main Loop Time      │  25-70 ms  │  5-15 ms    │  4-5x faster  │
│  Loop Frequency      │  14-40 Hz  │  66-200 Hz  │  5x faster    │
│  UART Response       │  25-70 ms  │  <1 ms      │  50x faster   │
│  LCD Update Rate     │  매 루프   │  변경시만    │  70% 감소    │
│  CPU Utilization     │  ~95%      │  ~40%       │  55% 절감    │
│  Command Miss Rate   │  ~10%      │  ~0%        │  완전 해소   │
│  Timing Accuracy     │  ±20%      │  ±1%        │  20x 정확    │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 부록

### A. 개발 환경
```
IDE:          STM32CubeIDE
HAL Version:  STM32Cube FW_F1 (HAL Driver)
Compiler:     ARM GCC
Debugger:     ST-Link V2
```

### B. 참고 자료
- STM32F103 Reference Manual (RM0008)
- STM32F103 Datasheet
- HC-SR04 Ultrasonic Sensor Datasheet
- PCF8574 I2C LCD Backpack Datasheet
- SG90 Servo Motor Specifications

### C. 버전 이력
| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 1.0 | 2025-01-28 | 초기 분석 문서 작성 |

---

> **Note**: 이 문서는 제공된 소스 코드를 기반으로 분석한 것으로, 실제 하드웨어 테스트 결과와 차이가 있을 수 있습니다. 최적화 적용 시 단계별 테스트를 권장합니다.
