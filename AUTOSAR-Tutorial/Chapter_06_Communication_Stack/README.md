# Chapter 06: Communication Stack

[← 이전 챕터](../Chapter_05_RTE/README.md) | [메인으로 돌아가기](../README.md) | [다음 챕터 →](../Chapter_07_Memory_Stack/README.md)

---

## 📋 목차

1. [학습 목표](#1-학습-목표)
2. [Communication Stack 개요](#2-communication-stack-개요)
3. [CAN 통신 스택](#3-can-통신-스택)
4. [LIN 통신 스택](#4-lin-통신-스택)
5. [Ethernet 통신 스택](#5-ethernet-통신-스택)
6. [요약 및 연습 문제](#6-요약-및-연습-문제)

---

## 1. 학습 목표

```
✅ Communication Stack의 계층 구조 이해
✅ CAN 통신 스택의 모듈과 데이터 흐름 파악
✅ COM, PduR, CanIf, Can 모듈의 역할 이해
✅ LIN 및 Ethernet 스택 개요 학습
```

---

## 2. Communication Stack 개요

### 2.1 통신 스택이란?

Communication Stack은 **ECU 간 네트워크 통신을 담당**하는 BSW 모듈들의 집합입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                Communication Stack 구조                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                         RTE                                     │
│  ───────────────────────────────────────────────────────────── │
│                          │                                      │
│                          ▼                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                       COM                                │   │
│  │           Signal ↔ I-PDU 변환, 전송 모드 관리            │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                       PduR                               │   │
│  │              PDU 라우팅 (멀티플렉싱)                      │   │
│  └──────┬─────────────────┬─────────────────┬──────────────┘   │
│         │                 │                 │                   │
│         ▼                 ▼                 ▼                   │
│  ┌───────────┐     ┌───────────┐     ┌───────────┐             │
│  │   CanIf   │     │   LinIf   │     │   EthIf   │             │
│  └─────┬─────┘     └─────┬─────┘     └─────┬─────┘             │
│        │                 │                 │                    │
│        ▼                 ▼                 ▼                    │
│  ┌───────────┐     ┌───────────┐     ┌───────────┐             │
│  │    Can    │     │    Lin    │     │    Eth    │             │
│  │   (MCAL)  │     │   (MCAL)  │     │   (MCAL)  │             │
│  └─────┬─────┘     └─────┬─────┘     └─────┬─────┘             │
│        │                 │                 │                    │
│  ──────┴─────────────────┴─────────────────┴────────────────── │
│                       Physical Bus                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 PDU 개념

**PDU(Protocol Data Unit)** 는 통신 스택에서 사용되는 데이터 단위입니다.

| PDU 종류 | 계층 | 설명 |
|----------|------|------|
| **I-PDU** | COM/PduR | Interaction Layer PDU (Signal 포함) |
| **N-PDU** | TP | Network Layer PDU (분할 전송) |
| **L-PDU** | If | Data Link Layer PDU (CAN Frame) |

---

## 3. CAN 통신 스택

### 3.1 CAN 스택 모듈

```
┌─────────────────────────────────────────────────────────────────┐
│                    CAN Communication Stack                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Services Layer                                                 │
│  ┌─────────┬─────────┬─────────┬─────────┐                     │
│  │   COM   │  CanSM  │  CanNm  │  CanTp  │                     │
│  │ Signal  │ State   │ Network │Transport│                     │
│  │ Handler │ Manager │ Mgmt    │ Protocol│                     │
│  └────┬────┴────┬────┴────┬────┴────┬────┘                     │
│       │         │         │         │                           │
│  ─────┴─────────┴─────────┴─────────┴─────                     │
│                                                                 │
│  ECU Abstraction Layer                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                        PduR                              │   │
│  │              PDU Router (라우팅, 게이트웨이)              │   │
│  └─────────────────────────┬───────────────────────────────┘   │
│                            │                                    │
│  ┌─────────────────────────▼───────────────────────────────┐   │
│  │                       CanIf                              │   │
│  │         CAN Interface (드라이버 추상화, L-PDU 관리)       │   │
│  └─────────────────────────┬───────────────────────────────┘   │
│                            │                                    │
│  MCAL                      │                                    │
│  ┌─────────────────────────▼───────────────────────────────┐   │
│  │                        Can                               │   │
│  │              CAN Driver (HW 레지스터 접근)               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 주요 모듈 역할

| 모듈 | 역할 |
|------|------|
| **COM** | Signal ↔ I-PDU 변환, 전송 모드 (Cyclic/Event), Signal Group |
| **PduR** | I-PDU 라우팅, 멀티캐스트, 게이트웨이 |
| **CanIf** | CAN 드라이버 추상화, L-PDU 버퍼 관리 |
| **Can** | CAN 컨트롤러 레지스터 직접 접근 (MCAL) |
| **CanSM** | CAN 네트워크 상태 관리 (Online/Offline) |
| **CanNm** | CAN 네트워크 관리 (Sleep/Wake) |
| **CanTp** | 대용량 데이터 분할 전송 (ISO 15765-2) |

### 3.3 송신 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                    CAN 송신 데이터 흐름                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  SWC: Rte_Write_PP_EngineSpeed_value(3000)                     │
│       │                                                         │
│       ▼                                                         │
│  RTE: Signal을 COM으로 전달                                     │
│       │                                                         │
│       ▼                                                         │
│  COM: 1. Signal을 I-PDU에 패킹 (Byte Order, Scaling)           │
│       2. 전송 조건 확인 (Cyclic/Event)                          │
│       3. Com_TriggerIPDUSend() 호출                            │
│       │                                                         │
│       ▼                                                         │
│  PduR: I-PDU를 CanIf로 라우팅                                   │
│       │                                                         │
│       ▼                                                         │
│  CanIf: 1. L-PDU 생성                                          │
│         2. 적절한 CAN 컨트롤러 선택                             │
│         3. Can_Write() 호출                                     │
│       │                                                         │
│       ▼                                                         │
│  Can: CAN 컨트롤러의 TX 버퍼에 데이터 기록                      │
│       │                                                         │
│       ▼                                                         │
│  CAN Bus: 0x123 [3000(RPM)]                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.4 COM Signal 설정 예시

```c
/* COM 설정 (ARXML에서 생성) */

/* Signal 정의 */
typedef struct {
    uint16 startBit;       /* 시작 비트 위치 */
    uint8 length;          /* 비트 길이 */
    ComSignalEndianness endianness;  /* Big/Little Endian */
    float32 factor;        /* 스케일링 Factor */
    float32 offset;        /* 스케일링 Offset */
} ComSignalConfigType;

/* 사용 예시: 엔진 속도 Signal */
/* 물리값 = (RawValue * Factor) + Offset */
/* 예: 3000 RPM = 3000 * 1.0 + 0 */

/* COM API 사용 */
void SendEngineSpeed(uint16 rpm)
{
    /* Signal 송신 (COM 모듈에 전달) */
    Com_SendSignal(ComConf_ComSignal_EngineSpeed, &rpm);
}

void ReceiveVehicleSpeed(void)
{
    uint16 speed;
    
    /* Signal 수신 (COM 모듈에서 읽기) */
    Com_ReceiveSignal(ComConf_ComSignal_VehicleSpeed, &speed);
}
```

---

## 4. LIN 통신 스택

### 4.1 LIN 스택 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                      LIN Stack 구조                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│       COM                                                       │
│        │                                                        │
│        ▼                                                        │
│       PduR                                                      │
│        │                                                        │
│        ▼                                                        │
│  ┌───────────┐     ┌───────────┐                               │
│  │   LinIf   │────►│  LinSM    │  (상태 관리)                   │
│  │           │     └───────────┘                               │
│  │           │     ┌───────────┐                               │
│  │           │────►│  LinTp    │  (진단 전송)                   │
│  └─────┬─────┘     └───────────┘                               │
│        │                                                        │
│        ▼                                                        │
│  ┌───────────┐                                                 │
│  │    Lin    │  (MCAL)                                         │
│  └───────────┘                                                 │
│                                                                 │
│  특징:                                                          │
│  - Master-Slave 구조                                           │
│  - 최대 16개 Slave                                             │
│  - 저비용, 저속 (최대 20kbps)                                   │
│  - 주로 도어, 시트, 미러 등 바디 제어                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. Ethernet 통신 스택

### 5.1 Ethernet 스택 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                   Ethernet Stack 구조                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Application                                                    │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      SoAd                                │   │
│  │              Socket Adaptor (BSD Socket 추상화)          │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│       ┌───────────────────┼───────────────────┐                │
│       │                   │                   │                │
│       ▼                   ▼                   ▼                │
│  ┌─────────┐        ┌─────────┐        ┌─────────┐            │
│  │  TcpIp  │        │   DoIP  │        │  SOME/IP│            │
│  │  Stack  │        │  (진단) │        │ (SOA)   │            │
│  └────┬────┘        └────┬────┘        └────┬────┘            │
│       │                  │                  │                  │
│       └──────────────────┴──────────────────┘                  │
│                          │                                      │
│                          ▼                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                       EthIf                              │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                        Eth                               │   │
│  │                      (MCAL)                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  특징:                                                          │
│  - 고속 통신 (100Mbps ~ 10Gbps)                                │
│  - ADAS, 인포테인먼트에 필수                                    │
│  - Service-Oriented Architecture 지원                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 Automotive Ethernet 특징

| 특징 | 설명 |
|------|------|
| **100BASE-T1** | 단일 Twisted Pair, 자동차 전용 |
| **DoIP** | Diagnosis over IP (UDS over Ethernet) |
| **SOME/IP** | Service-Oriented Middleware for Ethernet |
| **AVB/TSN** | 오디오/비디오 스트리밍, 시간 동기화 |

---

## 6. 요약 및 연습 문제

### 핵심 정리

```
┌─────────────────────────────────────────────────────────────────┐
│                    Chapter 06 핵심 정리                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📌 통신 스택 계층:                                              │
│     COM → PduR → If (CanIf/LinIf/EthIf) → Driver (MCAL)        │
│                                                                 │
│  📌 주요 모듈 역할:                                              │
│     ├── COM: Signal ↔ PDU 변환, 전송 모드                      │
│     ├── PduR: PDU 라우팅                                       │
│     ├── CanIf: CAN 드라이버 추상화                             │
│     └── Can: HW 레지스터 접근 (MCAL)                           │
│                                                                 │
│  📌 PDU 종류:                                                    │
│     ├── I-PDU: COM/PduR 레벨                                   │
│     ├── N-PDU: Transport Protocol 레벨                        │
│     └── L-PDU: Interface 레벨 (CAN Frame)                      │
│                                                                 │
│  📌 네트워크 종류:                                               │
│     ├── CAN: 주로 파워트레인, 섀시                             │
│     ├── LIN: 바디 제어 (저속, 저비용)                          │
│     └── Ethernet: ADAS, 인포테인먼트 (고속)                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 연습 문제

**문제 1.** CAN 송신 시 데이터가 거치는 모듈 순서는?

<details>
<summary>정답</summary>

RTE → COM → PduR → CanIf → Can → CAN Bus
</details>

**문제 2.** COM 모듈의 주요 역할 2가지는?

<details>
<summary>정답</summary>

1. Signal ↔ I-PDU 변환 (패킹/언패킹, Byte Order 처리)
2. 전송 모드 관리 (Cyclic, Event, Mixed)
</details>

**문제 3.** CAN, LIN, Ethernet의 주요 적용 분야는?

<details>
<summary>정답</summary>

- **CAN**: 파워트레인, 섀시, 안전 시스템
- **LIN**: 바디 제어 (도어, 시트, 미러)
- **Ethernet**: ADAS, 인포테인먼트, 고속 데이터 전송
</details>

---

[← 이전 챕터](../Chapter_05_RTE/README.md) | [메인으로 돌아가기](../README.md) | [다음 챕터 →](../Chapter_07_Memory_Stack/README.md)
